#!/usr/bin/env python3

"""Autogenerated TDF decoding logic"""

import ctypes

from collections.abc import Generator
from typing import Callable


class structs:
    class _struct_type(ctypes.LittleEndianStructure):
        def iter_fields(self) -> Generator[str, ctypes._SimpleCData, str, Callable]:
            for field in self._fields_:
                if field[0][0] == '_':
                    f_name = field[0][1:]
                else:
                    f_name = field[0]
                val = getattr(self, f_name)
                yield f_name, val, self._postfix_[f_name], self._display_fmt_[f_name]

{% for name, info in structs.items() %}
    class {{ name }}(_struct_type):
        """{{ info['description'] }}"""

        _fields_ = [
{% for field in info['fields'] %}
            ("{{ field['py_name'] }}", {{ field['py_type'] }}),
{% endfor %}
        ]
        _pack_ = 1
        _postfix_ = {
{% for fmt in info['displays'] %}
            "{{ fmt['name'] }}": {{ fmt['postfix'] }},
{% endfor %}
        }
        _display_fmt_ = {
{% for fmt in info['displays'] %}
            "{{ fmt['name'] }}": {{ fmt['fmt'] }},
{% endfor %}
        }
{% for conv in info['conversions'] %}

        @property
        def {{ conv['name'] }}(self):
            return self._{{ conv['name'] }}{{ conv['conv']}}
{% endfor %}

{% endfor %}
class readings:
    class _reading_type(ctypes.LittleEndianStructure):
        def iter_fields(self) -> Generator[str, ctypes._SimpleCData, str, Callable]:
            for field in self._fields_:
                if field[0][0] == '_':
                    f_name = field[0][1:]
                else:
                    f_name = field[0]
                val = getattr(self, f_name)
                if isinstance(val, ctypes.LittleEndianStructure):
                    for subfield_name, subfield_val, subfield_postfix, display_fmt in val.iter_fields():
                        yield f'{f_name}.{subfield_name}', subfield_val, subfield_postfix, display_fmt
                elif isinstance(val, ctypes.Array):
                    yield f_name, list(val), self._postfix_[f_name], self._display_fmt_[f_name]
                else:
                    yield f_name, val, self._postfix_[f_name], self._display_fmt_[f_name]

{% for tdf_id, info in definitions.items() %}
    class {{ info['name'] | lower }}(_reading_type):
        """{{ info['description'] }}"""

        name = "{{ info['name'] }}"
        _fields_ = [
{% for field in info['fields'] %}
            ("{{ field['py_name'] }}", {{ field['py_type'] }}),
{% endfor %}
        ]
        _pack_ = 1
        _postfix_ = {
{% for fmt in info['displays'] %}
            "{{ fmt['name'] }}": {{ fmt['postfix'] }},
{% endfor %}
        }
        _display_fmt_ = {
{% for fmt in info['displays'] %}
            "{{ fmt['name'] }}": {{ fmt['fmt'] }},
{% endfor %}
        }
{% for conv in info['conversions'] %}

        @property
        def {{ conv['name'] }}(self):
            return self._{{ conv['name'] }}{{ conv['conv']}}
{% endfor %}

{% endfor %}
id_type_mapping = {
{% for tdf_id, info in definitions.items() %}
    {{ tdf_id }}: readings.{{ info['name'] | lower }},
{% endfor %}
}
