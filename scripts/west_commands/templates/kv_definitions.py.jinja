#!/usr/bin/env python3
# mypy: ignore-errors

"""Autogenerated KV store definitions"""

import ctypes

from infuse_iot.util.ctypes import VLACompatLittleEndianStruct


class structs:
{% if extensions %}
    EXTENSIONS = True

{% endif %}
{% for name, info in structs.items() %}
{% if extensions == info.get('extension', False) %}
    class {{ name }}(VLACompatLittleEndianStruct):
        """{{ info['description'] }}"""

        _fields_ = [
{% for field in info['fields'] %}
{% if field['num'] == 0 %}
{% if info['fields']|length == 1 %}
            ("{{ field['name'] }}_num", ctypes.c_uint8),
{% endif %}
{% else %}
            ("{{ field['name'] }}", {{ field['py_type'] }}),
{% endif %}
{% endfor %}
        ]
{% if 'flexible' in info %}
        vla_field = ("{{ info['fields'][-1]['name'] }}", {{ info['fields'][-1]['py_type'] }})
{% endif %}
{% if 'counted_by' in info %}
        vla_counted_by = "{{ info['counted_by'] }}"
{% endif %}
        _pack_ = 1
{% if name == "kv_string" %}

        def __str__(self) -> str:
            return bytes(self.value).decode('utf-8')
{% endif %}

{% endif %}
{% endfor %}

class slots:
{% if extensions %}
    EXTENSIONS = True

{% endif %}
{% for base_id, info in definitions.items() %}
{% if extensions == info.get('extension', False) %}
    class {{ info['name'] | lower }}(VLACompatLittleEndianStruct):
        """{{ info['description'] }}"""

        NAME = "{{ info['name'] }}"
        BASE_ID = {{ base_id }}
        RANGE = {{ info.get('range', 1) }}
        _fields_ = [
{% for field in info['fields'] %}
{% if 'flexible' in info and (loop.index == (info['fields']|length)) %}
{% if info['fields']|length == 1 and not field['py_type'].startswith('structs.') %}
            ("{{ field['name'] }}_num", ctypes.c_uint8),
{% endif %}
{% else %}
            ("{{ field['name'] }}", {{ field['py_type'] }}),
{% endif %}
{% endfor %}
        ]
{% if 'flexible' in info %}
        vla_field = ("{{ info['fields'][-1]['name'] }}", {{ info['fields'][-1]['py_type'] }})
{% endif %}
{% if 'counted_by' in info %}
        vla_counted_by = "{{ info['counted_by'] }}"
{% endif %}
        _pack_ = 1

{% endif %}
{% endfor %}
    ID_MAPPING = {
{% for base_id, info in definitions.items() %}
{% if extensions == info.get('extension', False) %}
{% for idx in range(info.get('range', 1)) %}
        {{ base_id + idx }}: {{ info['name'] | lower }},
{% endfor %}
{% endif %}
{% endfor %}
    }

__all__ = [
     'structs',
     'slots',
]
